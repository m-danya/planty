<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Загрузка файла с использованием presigned POST</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }
      textarea,
      input[type="text"],
      input[type="url"],
      input[type="uuid"] {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
      }
      #uploadButton, #fetchUrlsButton {
        padding: 10px 20px;
        font-size: 16px;
        margin-right: 10px;
      }
      #result {
        margin-top: 20px;
      }
      #result img {
        max-width: 100%;
        height: auto;
      }
      #error {
        color: red;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Загрузка файла с использованием presigned POST</h1>

    <div class="form-group">
      <label for="taskId">Task ID (UUID):</label>
      <input
        type="text"
        id="taskId"
        placeholder="Введите UUID задачи"
        required
      />
    </div>

    <div class="form-group">
      <label for="fileInput">Выберите файл для загрузки:</label>
      <input type="file" id="fileInput" accept="image/*" required />
    </div>

    <button id="fetchUrlsButton">Получить URL для загрузки</button>
    <button id="uploadButton" disabled>Загрузить файл</button>

    <div id="result"></div>
    <div id="error"></div>

    <script>
      document.getElementById("fetchUrlsButton").addEventListener("click", async () => {
        // Очистка предыдущих результатов и ошибок
        document.getElementById("result").innerHTML = "";
        document.getElementById("error").innerText = "";

        const taskId = document.getElementById("taskId").value.trim();

        if (!taskId) {
          document.getElementById("error").innerText = "Пожалуйста, введите Task ID.";
          return;
        }

        try {
          // Отправка POST запроса к эндпоинту /task/attachment
          const response = await fetch("http://127.0.0.1:8000/api/task/attachment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ task_id: taskId }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Ошибка при получении URL: ${response.status} ${response.statusText}\n${errorText}`);
          }

          const urls = await response.json();

          // Сохранение полученных URL в атрибутах кнопки загрузки
          document.getElementById("uploadButton").dataset.postUrl = urls.post_url;
          document.getElementById("uploadButton").dataset.postFields = JSON.stringify(urls.post_fields);
          document.getElementById("uploadButton").dataset.getUrl = urls.get_url;

          // Активация кнопки загрузки
          document.getElementById("uploadButton").disabled = false;

          alert("URL для загрузки успешно получены. Теперь вы можете загрузить файл.");
        } catch (error) {
          document.getElementById("error").innerText = `Произошла ошибка: ${error.message}`;
          console.error(error);
        }
      });

      document.getElementById("uploadButton").addEventListener("click", async () => {
        // Очистка предыдущих результатов и ошибок
        document.getElementById("result").innerHTML = "";
        document.getElementById("error").innerText = "";

        const fileInput = document.getElementById("fileInput").files[0];

        if (!fileInput) {
          document.getElementById("error").innerText = "Пожалуйста, выберите файл для загрузки.";
          return;
        }

        const postUrl = document.getElementById("uploadButton").dataset.postUrl;
        const postFields = JSON.parse(document.getElementById("uploadButton").dataset.postFields);
        const getUrl = document.getElementById("uploadButton").dataset.getUrl;

        // Создание FormData и добавление полей из postFields
        const formData = new FormData();
        for (const [key, value] of Object.entries(postFields)) {
          formData.append(key, value);
        }

        // Добавление Content-Disposition для имени файла
        formData.append(
          "Content-Disposition",
          `attachment; filename="${fileInput.name}"`
        );

        // Добавление файла
        formData.append("file", fileInput);

        try {
          // Отправка POST запроса к presigned URL
          const response = await fetch(postUrl, {
            method: "POST",
            body: formData,
          });

          if (response.ok || response.status === 204) {
            // Отображение загруженного изображения
            const img = document.createElement("img");
            img.src = getUrl;
            img.alt = "Загруженное изображение";
            document.getElementById("result").appendChild(img);
          } else {
            const errorText = await response.text();
            throw new Error(`Ошибка при загрузке файла: ${response.status} ${response.statusText}\n${errorText}`);
          }
        } catch (error) {
          document.getElementById("error").innerText = `Произошла ошибка: ${error.message}`;
          console.error(error);
        }
      });
    </script>
  </body>
</html>
